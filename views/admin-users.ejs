<%- include('partials/head', { title }) %>
<%- include('partials/navbar') %>

<main class="mx-auto flex w-full max-w-7xl flex-1 flex-col gap-10 px-4 py-12 sm:px-6 lg:px-8">
  <header class="flex flex-col gap-6 rounded-3xl bg-gradient-to-br from-primary-50 to-primary-100 p-8 shadow-lg">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div class="space-y-3">
        <div class="flex items-center gap-3">
          <div class="flex h-12 w-12 items-center justify-center rounded-2xl bg-primary-600 text-white shadow-lg">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
            </svg>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-primary-800">จัดการสมาชิก</h1>
            <p class="text-sm text-primary-600">จัดการข้อมูลสมาชิกและสิทธิ์การเข้าถึง</p>
          </div>
        </div>
        <p class="max-w-2xl text-sm leading-relaxed text-slate-600">
          ตรวจสอบ อนุมัติ และจัดการข้อมูลสมาชิกทั้งหมดในระบบ
        </p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <a
          href="/register"
          class="inline-flex items-center gap-2 rounded-xl bg-primary-600 px-6 py-3 text-sm font-semibold text-white shadow-lg transition hover:-translate-y-0.5 hover:bg-primary-700"
        >
          <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m7-7H5" />
          </svg>
          เพิ่มสมาชิกใหม่
        </a>
        <a
          href="/admin/dashboard"
          class="inline-flex items-center gap-2 rounded-xl border border-primary-200 bg-white px-6 py-3 text-sm font-semibold text-primary-600 transition hover:bg-primary-50"
        >
          <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
          </svg>
          กลับแดชบอร์ด
        </a>
      </div>
    </div>
  </header>

  <%- include('partials/flash') %>

  <!-- Statistics Cards -->
  <%
    const totalUsers = Array.isArray(users) ? users.length : 0;
    const adminCount = Array.isArray(users) ? users.filter((item) => item.role === 'admin').length : 0;
    const staffCount = Array.isArray(users) ? users.filter((item) => item.role === 'staff').length : 0;
    const pendingUsers = Array.isArray(users) ? users.filter((item) => !item.isApproved) : [];
    const approvedUsers = Array.isArray(users) ? users.filter((item) => item.isApproved) : [];
  %>

  <section class="grid gap-6 sm:grid-cols-2 xl:grid-cols-4">
    <div class="group relative overflow-hidden rounded-2xl bg-gradient-to-br from-primary-500 to-primary-600 p-6 text-white shadow-xl transition-all duration-300 hover:scale-105 hover:shadow-2xl">
      <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
      <div class="relative">
        <div class="flex items-center justify-between">
          <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-white/20 backdrop-blur-sm">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
            </svg>
          </div>
          <div class="text-right">
            <p class="text-3xl font-bold"><%= totalUsers %></p>
            <p class="text-sm text-white/80">สมาชิกทั้งหมด</p>
          </div>
        </div>
        <div class="mt-4 flex items-center gap-2">
          <div class="flex h-2 w-2 rounded-full bg-white/60"></div>
          <span class="text-sm text-white/90">อนุมัติแล้ว <%= approvedUsers.length %> คน</span>
        </div>
      </div>
    </div>

    <div class="group rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-all duration-300 hover:border-primary-300 hover:shadow-lg">
      <div class="flex items-center justify-between">
        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-primary-100 text-primary-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.623 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
          </svg>
        </div>
        <div class="text-right">
          <p class="text-3xl font-bold text-primary-700"><%= adminCount %></p>
          <p class="text-sm text-slate-600">ผู้ดูแลระบบ</p>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex items-center justify-between text-sm">
          <span class="text-slate-500">เปอร์เซ็นต์</span>
          <span class="font-semibold text-primary-600">
            <%= totalUsers ? Math.round((adminCount / Math.max(totalUsers, 1)) * 100) : 0 %>%
          </span>
        </div>
        <div class="mt-2 h-2 w-full rounded-full bg-slate-200">
          <div class="h-2 rounded-full bg-primary-500" style="width: <%= totalUsers ? Math.round((adminCount / Math.max(totalUsers, 1)) * 100) : 0 %>%"></div>
        </div>
      </div>
    </div>

    <div class="group rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-all duration-300 hover:border-emerald-300 hover:shadow-lg">
      <div class="flex items-center justify-between">
        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-emerald-100 text-emerald-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3.375 3.375 0 11-6 0 3.375 3.375 0 016.75 0zm6 3a2.25 2.25 0 11-4.5 0 2.625 2.625 0 015.25 0z" />
          </svg>
        </div>
        <div class="text-right">
          <p class="text-3xl font-bold text-emerald-600"><%= staffCount %></p>
          <p class="text-sm text-slate-600">เจ้าหน้าที่</p>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex items-center justify-between text-sm">
          <span class="text-slate-500">เปอร์เซ็นต์</span>
          <span class="font-semibold text-emerald-600">
            <%= totalUsers ? Math.round((staffCount / Math.max(totalUsers, 1)) * 100) : 0 %>%
          </span>
        </div>
        <div class="mt-2 h-2 w-full rounded-full bg-slate-200">
          <div class="h-2 rounded-full bg-emerald-500" style="width: <%= totalUsers ? Math.round((staffCount / Math.max(totalUsers, 1)) * 100) : 0 %>%"></div>
        </div>
      </div>
    </div>

    <div class="group rounded-2xl border border-amber-200 bg-gradient-to-br from-amber-50 to-amber-100 p-6 shadow-sm transition-all duration-300 hover:border-amber-300 hover:shadow-lg">
      <div class="flex items-center justify-between">
        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-amber-200 text-amber-700">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4h3m6 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="text-right">
          <p class="text-3xl font-bold text-amber-700"><%= pendingUsers.length %></p>
          <p class="text-sm text-amber-600">รอการอนุมัติ</p>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex items-center gap-2 text-sm">
          <div class="flex h-2 w-2 rounded-full bg-amber-500"></div>
          <span class="text-amber-700">
            <% if (pendingUsers.length > 0) { %>
              เหลืออีก <%= pendingUsers.length %> รายการ
            <% } else { %>
              อนุมัติครบทุกคนแล้ว
            <% } %>
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- Users Table -->
  <section class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200">
    <div class="flex flex-wrap items-center justify-between gap-3 border-b border-slate-100 px-6 py-5">
      <div class="flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-slate-100 text-slate-600">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
          </svg>
        </div>
        <div>
          <h2 class="text-lg font-semibold text-slate-800">รายชื่อสมาชิกทั้งหมด</h2>
          <p class="text-xs text-slate-500">เรียงตามวันที่สร้างล่าสุด</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600">
          ทั้งหมด <%= totalUsers %> รายการ
        </span>
      </div>
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50/80 text-xs uppercase tracking-wide text-slate-500">
          <tr>
            <th scope="col" class="px-4 py-3 text-left">สมาชิก</th>
            <th scope="col" class="px-4 py-3 text-left">ตำแหน่ง / สังกัด</th>
            <th scope="col" class="px-4 py-3 text-left">ติดต่อ</th>
            <th scope="col" class="px-4 py-3 text-left">สิทธิ์และสถานะ</th>
            <th scope="col" class="px-4 py-3 text-center">การจัดการ</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          <% if (users && users.length) { %>
            <% users.forEach((user) => { %>
              <tr class="align-top transition hover:bg-primary-50/20 <%= user.isApproved ? '' : 'bg-amber-50/50' %>">
                <td class="px-4 py-4">
                  <div class="flex items-start gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary-100 font-semibold text-primary-700">
                      <%= (user.name || '?').slice(0, 1).toUpperCase() %>
                    </div>
                    <div>
                      <div class="flex items-center gap-2">
                        <span class="text-sm font-semibold text-slate-800"><%= user.name %></span>
                        <% if (currentUser && currentUser.id === user.id) { %>
                          <span class="rounded-full bg-emerald-100 px-2 py-0.5 text-[11px] font-medium text-emerald-600">
                            คุณ
                          </span>
                        <% } %>
                      </div>
                      <div class="mt-1 font-mono text-xs text-primary-600">
                        <%= user.email %>
                      </div>
                    </div>
                  </div>
                </td>
                <td class="px-4 py-4 text-sm text-slate-600">
                  <div class="font-medium text-slate-700"><%= user.position || 'ไม่ระบุตำแหน่ง' %></div>
                  <div class="mt-1 text-xs text-slate-500"><%= user.affiliation || 'ไม่ได้ระบุหน่วยงาน' %></div>
                </td>
                <td class="px-4 py-4 text-sm text-slate-600">
                  <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
                    <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2.5 py-0.5">
                      <svg class="h-3.5 w-3.5 text-slate-400" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75 12 12l9.75-5.25M2.25 17.25 12 12l9.75 5.25" />
                      </svg>
                      <span><%= user.phone || 'ยังไม่ระบุ' %></span>
                    </span>
                    <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2.5 py-0.5">
                      <svg class="h-3.5 w-3.5 text-slate-400" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 1.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                      </svg>
                      <span><%= new Date(user.createdAt).toLocaleString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %></span>
                    </span>
                  </div>
                </td>
                <td class="px-4 py-4">
                  <div class="flex flex-wrap gap-2 text-xs font-semibold">
                    <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 <%= user.role === 'admin' ? 'bg-primary-100 text-primary-700' : 'bg-slate-100 text-slate-600' %>">
                      <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m12 6 7.5 4.5-7.5 4.5L4.5 10.5 12 6Z" />
                      </svg>
                      <%= user.role === 'admin' ? 'ผู้ดูแลระบบ' : 'เจ้าหน้าที่' %>
                    </span>
                    <% if (user.isApproved) { %>
                      <span class="inline-flex items-center gap-1 rounded-full bg-emerald-100 px-3 py-1 text-emerald-700">
                        <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                        </svg>
                        ยืนยันแล้ว
                      </span>
                    <% } else { %>
                      <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-3 py-1 text-amber-700">
                        <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4h3m6 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        รออนุมัติ
                      </span>
                    <% } %>
                  </div>
                </td>
                <td class="px-4 py-4">
                  <div class="flex flex-col items-stretch justify-center gap-2 sm:flex-row">
                    <form action="/admin/users/<%= user.id %>/approval" method="post">
                      <input type="hidden" name="action" value="<%= user.isApproved ? 'revoke' : 'approve' %>" />
                      <button
                        type="submit"
                        class="inline-flex w-full items-center justify-center gap-1 rounded-full px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition <%= user.isApproved ? 'bg-amber-500/90 hover:bg-amber-600' : 'bg-emerald-500/90 hover:bg-emerald-600' %> <%= currentUser && currentUser.id === user.id ? 'cursor-not-allowed opacity-60' : '' %>"
                        <%= currentUser && currentUser.id === user.id ? 'disabled' : '' %>
                      >
                        <svg class="h-3.5 w-3.5 text-white/80" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                        </svg>
                        <%= user.isApproved ? 'ยกเลิกยืนยัน' : 'อนุมัติบัญชี' %>
                      </button>
                    </form>
                    <form action="/admin/users/<%= user.id %>/role" method="post" class="flex items-center justify-center gap-2">
                      <select
                        name="role"
                        class="rounded-full border border-slate-200 px-3 py-1 text-xs font-medium text-slate-600 focus:border-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-200 disabled:cursor-not-allowed disabled:bg-slate-100"
                        <%= currentUser && currentUser.id === user.id ? 'disabled' : '' %>
                      >
                        <option value="staff" <%= user.role === 'staff' ? 'selected' : '' %>>เจ้าหน้าที่</option>
                        <option value="admin" <%= user.role === 'admin' ? 'selected' : '' %>>ผู้ดูแลระบบ</option>
                      </select>
                      <button
                        type="submit"
                        class="inline-flex items-center gap-1 rounded-full bg-primary-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-primary-700 disabled:cursor-not-allowed disabled:bg-slate-300"
                        <%= currentUser && currentUser.id === user.id ? 'disabled' : '' %>
                      >
                        <svg class="h-3.5 w-3.5 text-white/90" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13a4 4 0 0 1 4-4h9m0 0-3-3m3 3-3 3" />
                        </svg>
                        บันทึก
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="5" class="px-6 py-12 text-center text-slate-500">
                ยังไม่มีข้อมูลสมาชิกในระบบ เริ่มต้นด้วยการเพิ่มสมาชิกใหม่ทันที
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </section>
</main>

<%- include('partials/footer') %>
