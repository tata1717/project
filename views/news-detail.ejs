<%- include('partials/head', { title }) %>
<%- include('partials/navbar') %>

<main class="mx-auto flex w-full max-w-4xl flex-1 flex-col gap-10 px-4 py-12 sm:px-6 lg:px-8">
  <article class="overflow-hidden rounded-3xl bg-white/95 shadow-md ring-1 ring-black/5 backdrop-blur">
    <% if (article.imagePath) { %>
      <figure class="relative">
        <img
          src="/<%= article.imagePath %>"
          alt="<%= article.imageCaption || article.title %>"
          class="h-64 w-full object-cover sm:h-80"
        />
        <% if (article.imageCaption) { %>
          <figcaption class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent px-6 py-4 text-sm text-white">
            <%= article.imageCaption %>
          </figcaption>
        <% } %>
      </figure>
    <% } %>

    <div class="space-y-8 px-6 py-10 sm:px-10 sm:py-12">
      <header class="space-y-4">
        <div class="flex flex-wrap items-center justify-between gap-3 text-xs uppercase tracking-wide text-slate-400">
          <span class="inline-flex items-center gap-2">
            <svg class="h-3.5 w-3.5 text-primary-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10m-12 8h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2Z" />
            </svg>
            เผยแพร่เมื่อ <span class="font-medium text-slate-600 normal-case">
              <%= new Date(article.createdAt).toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' }) %>
            </span>
          </span>
          <% if (article.updatedAt && article.updatedAt !== article.createdAt) { %>
            <span class="inline-flex items-center gap-2">
              <svg class="h-3.5 w-3.5 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
              ปรับปรุงล่าสุด <span class="font-medium text-slate-600 normal-case">
                <%= new Date(article.updatedAt).toLocaleString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
              </span>
            </span>
          <% } %>
        </div>
        <h1 class="text-3xl font-semibold leading-tight text-primary-700 sm:text-4xl"><%= article.title %></h1>
      </header>

      <section class="flex flex-col gap-4 rounded-2xl bg-slate-50/80 p-5 sm:flex-row sm:items-center sm:gap-6">
        <% const authorName = article.author && article.author.name ? article.author.name : 'ทีมผู้ดูแลระบบ'; %>
        <% const authorInitial = authorName.trim().charAt(0).toUpperCase(); %>
        <% if (article.author && article.author.image) { %>
          <img
            src="/<%= article.author.image %>"
            alt="<%= authorName %>"
            class="h-14 w-14 rounded-full object-cover ring-2 ring-white shadow"
          />
        <% } else { %>
          <span class="inline-flex h-14 w-14 items-center justify-center rounded-full bg-primary-100 text-lg font-semibold text-primary-600 ring-2 ring-white shadow">
            <%= authorInitial %>
          </span>
        <% } %>
        <div class="min-w-0 flex-1">
          <p class="truncate text-sm font-semibold text-slate-700"><%= authorName %></p>
          <p class="truncate text-xs text-slate-500">
            <%= article.author && article.author.position ? article.author.position : 'ผู้ดูแลระบบ' %>
            <% if (article.author && article.author.affiliation) { %>
              · <span class="truncate"><%= article.author.affiliation %></span>
            <% } %>
          </p>
          <% if (article.author && article.author.email) { %>
            <p class="truncate text-xs text-slate-400">
              <span class="font-medium text-slate-500">ติดต่อ:</span> <%= article.author.email %>
            </p>
          <% } %>
        </div>
      </section>

      <section class="article-body space-y-4 text-base leading-relaxed text-slate-700">
        <div class="prose prose-sm max-w-none text-slate-700 prose-headings:text-primary-700 prose-a:text-primary-600">
          <%- article.content %>
        </div>
      </section>

      <% if (article.attachments && article.attachments.length) { %>
        <section class="space-y-4 rounded-2xl border border-slate-200 bg-slate-50/70 p-5">
          <header class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-700">
              ไฟล์แนบ (<%= article.attachments.length %>)
            </h2>
            <span class="text-xs text-slate-500">รองรับไฟล์สูงสุด 50 MB ต่อไฟล์</span>
          </header>
          <% const isMember = currentUser && ['admin', 'staff'].includes(currentUser.role); %>
          <% if (!isMember) { %>
            <div class="rounded-xl bg-amber-50 border border-amber-200 p-4">
              <p class="text-sm text-amber-800">
                <svg class="inline h-4 w-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                </svg>
                ต้องเป็นสมาชิกถึงจะสามารถดาวน์โหลดไฟล์ได้
              </p>
            </div>
          <% } %>
          <ul class="space-y-3 text-sm text-slate-600">
            <% article.attachments.forEach((file) => { %>
              <% const sizeMB = file.fileSize ? (file.fileSize / (1024 * 1024)).toFixed(2) : '0.00'; %>
              <li class="flex flex-col gap-2 rounded-xl bg-white px-4 py-3 shadow-sm sm:flex-row sm:items-center sm:justify-between">
                <div class="flex min-w-0 flex-col">
                  <span class="truncate font-medium <%= isMember ? 'text-primary-600' : 'text-slate-400' %>">
                    <%= file.originalName %>
                  </span>
                  <span class="text-xs text-slate-500">
                    <%= sizeMB %> MB · อัปโหลดเมื่อ
                    <%= new Date(file.createdAt).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' }) %>
                  </span>
                </div>
                <% if (isMember) { %>
                  <a
                    href="/news/files/<%= file.id %>/download"
                    class="inline-flex items-center justify-center gap-2 rounded-lg border border-primary-200 px-3 py-1.5 text-xs font-medium text-primary-600 transition hover:bg-primary-50"
                  >
                    ดาวน์โหลด
                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2m-4-4-4 4m0 0-4-4m4 4V4" />
                    </svg>
                  </a>
                <% } else { %>
                  <a
                    href="/login"
                    class="inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 px-3 py-1.5 text-xs font-medium text-slate-400 cursor-not-allowed"
                    title="ต้องเข้าสู่ระบบก่อน"
                  >
                    ดาวน์โหลด
                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                    </svg>
                  </a>
                <% } %>
              </li>
            <% }) %>
          </ul>
        </section>
      <% } %>

      <footer class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center gap-4">
          <button id="likeButton" class="inline-flex items-center gap-2 text-sm font-medium <%= article.hasLiked ? 'text-red-500' : 'text-slate-600' %> transition hover:text-red-500">
            <svg class="h-5 w-5" fill="<%= article.hasLiked ? 'currentColor' : 'none' %>" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
            </svg>
            ถูกใจ (<span id="likeCount"><%= article.likeCount %></span>)
          </button>
          <button id="shareButton" class="inline-flex items-center gap-2 text-sm font-medium text-slate-600 transition hover:text-primary-700">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.186 2.25 2.25 0 0 0-3.933 2.186Z" />
            </svg>
            แชร์
          </button>
        </div>
        <div class="flex items-center gap-4">
          <a
            href="/"
            class="inline-flex items-center gap-2 text-sm font-medium text-primary-600 transition hover:text-primary-700"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            กลับสู่หน้าแรก
          </a>
          <% if (canEdit) { %>
            <a
              href="/admin/news/<%= article.id %>/edit"
              class="inline-flex items-center gap-2 rounded-xl border border-primary-200 px-4 py-2 text-xs font-medium text-primary-600 transition hover:bg-primary-50"
            >
              <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232a2.5 2.5 0 1 1 3.536 3.536L8.5 19.036 4 20l.964-4.5 10.268-10.268Z" />
              </svg>
              แก้ไขข่าวนี้
            </a>
          <% } %>
        </div>
      </footer>
    </div>
  </article>
</main>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const likeButton = document.getElementById('likeButton');
    const likeCountSpan = document.getElementById('likeCount');
    const shareButton = document.getElementById('shareButton');
    const articleId = <%= article.id %>;

    if (likeButton) {
      likeButton.addEventListener('click', async () => {
        try {
          const response = await fetch(`/news/${articleId}/like`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });
          const data = await response.json();

          if (data.success) {
            likeCountSpan.textContent = data.likeCount;
            if (data.hasLiked) {
              likeButton.classList.add('text-red-500');
              likeButton.querySelector('svg').setAttribute('fill', 'currentColor');
            } else {
              likeButton.classList.remove('text-red-500');
              likeButton.querySelector('svg').setAttribute('fill', 'none');
            }
          } else {
            alert(data.message || 'เกิดข้อผิดพลาดในการดำเนินการ');
            if (response.status === 401) {
              window.location.href = '/login';
            }
          }
        } catch (error) {
          console.error('Error liking post:', error);
          alert('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้');
        }
      });
    }

    if (shareButton) {
      shareButton.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(window.location.href);
          alert('คัดลอกลิงก์ไปยังคลิปบอร์ดแล้ว!');
        } catch (err) {
          console.error('Failed to copy: ', err);
          alert('ไม่สามารถคัดลอกลิงก์ได้ กรุณาคัดลอกด้วยตนเอง');
        }
      });
    }
  });
</script>
<%- include('partials/footer') %>

<%- include('partials/footer') %>
