<%
  const isAuthenticated = Boolean(currentUser);
  const isAdmin = isAuthenticated && currentUser.role === 'admin';
  const dashboardLink = isAdmin ? '/admin/dashboard' : '/staff/dashboard';
  const dashboardLabel = isAdmin ? 'แดชบอร์ดผู้ดูแล' : 'แดชบอร์ดเจ้าหน้าที่';
  const homeHref = isAuthenticated ? '/home' : '/';
  const siteSettings = (typeof site === 'object' && site) ? site : {};
  const siteName = siteSettings.siteName || 'ระบบจัดการสมาชิก';
  const siteLogoUrl = siteSettings.siteLogoUrl || null;
  const siteInitial = siteName.slice(0, 1).toUpperCase();
  const siteClosed = Boolean(siteSettings.isClosed);
%>
<nav class="sticky top-0 z-50 border-b border-white/70 bg-white/90 backdrop-blur-xl shadow-[0_12px_30px_-16px_rgba(15,23,42,0.45)]">
  <div class="mx-auto flex h-16 max-w-6xl items-center justify-between gap-4 px-4 sm:px-6 lg:px-8">
    <a
      href="<%= homeHref %>"
      class="group inline-flex items-center gap-3 rounded-full border border-white/70 bg-white px-3 py-1.5 shadow-sm transition hover:-translate-y-0.5 hover:border-primary-200 hover:bg-white"
    >
      <% if (siteLogoUrl) { %>
        <span class="flex h-9 w-9 items-center justify-center overflow-hidden rounded-2xl border border-primary-100 bg-white shadow-md transition group-hover:scale-105">
          <img src="<%= siteLogoUrl %>" alt="<%= siteName %>" class="h-full w-full object-cover" />
        </span>
      <% } else { %>
        <span class="grid h-9 w-9 place-items-center rounded-2xl bg-gradient-to-br from-primary-500 via-primary-600 to-primary-700 text-sm font-semibold uppercase text-white shadow-md transition group-hover:scale-105">
          <%= siteInitial %>
        </span>
      <% } %>
      <span class="text-left leading-tight">
        <span class="block text-[0.65rem] uppercase tracking-[0.32em] text-primary-400">Membership</span>
        <span class="block text-base font-semibold text-slate-800"><%= siteName %></span>
      </span>
    </a>
    <% if (siteClosed && isAdmin) { %>
      <span class="hidden rounded-full bg-rose-100 px-3 py-1 text-[11px] font-semibold text-rose-600 md:inline">
        โหมดปิดปรับปรุง
      </span>
    <% } %>

    <div class="hidden items-center gap-6 text-sm font-medium text-slate-600 md:flex">
      <a
        href="<%= homeHref %>"
        class="inline-flex items-center gap-2 rounded-full border border-transparent px-3 py-1.5 transition hover:border-primary-200 hover:text-primary-600 hover:shadow"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="m3 11.25 9-6.75 9 6.75m-2.25 0v6.75a1.5 1.5 0 0 1-1.5 1.5h-3.75m-6-8.25v8.25a1.5 1.5 0 0 0 1.5 1.5H12" />
        </svg>
        หน้าเว็บไซต์
      </a>
      <% if (isAuthenticated) { %>
        <div class="relative" data-dropdown>
          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-full border border-transparent px-3 py-1.5 transition hover:border-primary-200 hover:text-primary-600 hover:shadow"
            data-dropdown-button
            aria-haspopup="true"
            aria-expanded="false"
          >
            <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 6H19.5M4.5 12H19.5M4.5 18H12" />
            </svg>
            จัดการระบบ
            <svg class="h-4 w-4 text-slate-400 transition" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div
            class="absolute right-0 z-40 mt-2 hidden min-w-[14rem] rounded-2xl border border-slate-100 bg-white/95 p-2 text-sm shadow-xl ring-1 ring-black/5"
            data-dropdown-menu
            role="menu"
          >
            <a
              href="<%= dashboardLink %>"
              class="flex items-center gap-2 rounded-xl px-3 py-2 text-slate-600 transition hover:bg-primary-50 hover:text-primary-700"
              role="menuitem"
            >
              <svg class="h-5 w-5 text-primary-500" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5h15M6 16.5v-6a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3v6" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19.5v-3.75A1.5 1.5 0 0 1 10.5 14.25h3a1.5 1.5 0 0 1 1.5 1.5V19.5" />
              </svg>
              <%= dashboardLabel %>
            </a>
            <% if (isAdmin) { %>
              <a
                href="/admin/slider"
                class="flex items-center gap-2 rounded-xl px-3 py-2 text-slate-600 transition hover:bg-primary-50 hover:text-primary-700"
                role="menuitem"
              >
                <svg class="h-5 w-5 text-primary-500" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M7 12h10M10 18h4" />
                </svg>
                จัดการภาพสไลด์
              </a>
              <a
                href="/admin/news"
                class="flex items-center gap-2 rounded-xl px-3 py-2 text-slate-600 transition hover:bg-primary-50 hover:text-primary-700"
                role="menuitem"
              >
                <svg class="h-5 w-5 text-primary-500" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 12h16m-7 5h7" />
                </svg>
                ข่าวประชาสัมพันธ์
              </a>
              <a
                href="/admin/settings"
                class="flex items-center gap-2 rounded-xl px-3 py-2 text-slate-600 transition hover:bg-primary-50 hover:text-primary-700"
                role="menuitem"
              >
                <svg class="h-5 w-5 text-primary-500" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 6h.01M4.5 12a7.5 7.5 0 1 1 15 0 7.5 7.5 0 0 1-15 0Z" />
                </svg>
                ตั้งค่าเว็บไซต์
              </a>
              <div class="my-1 border-t border-slate-100"></div>
              <a
                href="/register"
                class="flex items-center gap-2 rounded-xl px-3 py-2 text-slate-600 transition hover:bg-primary-50 hover:text-primary-700"
                role="menuitem"
              >
                <svg class="h-5 w-5 text-primary-500" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m7-7H5" />
                </svg>
                เพิ่มสมาชิกใหม่
              </a>
            <% } %>
          </div>
        </div>
      <% } %>
    </div>

        <div class="hidden items-center gap-3 md:flex">
      <% if (isAuthenticated) { %>
        <div class="relative" data-dropdown>
          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-full border border-transparent px-2 py-1 transition hover:border-primary-200 hover:text-primary-600 hover:shadow"
            data-dropdown-button
            aria-haspopup="true"
            aria-expanded="false"
          >
            <span class="grid h-8 w-8 place-items-center rounded-full bg-primary-600 text-sm font-semibold uppercase text-white shadow-sm">
              <%= (currentUser.name || '?').slice(0, 1).toUpperCase() %>
            </span>
            <div class="text-left leading-tight">
              <span class="block max-w-[8rem] truncate text-sm font-semibold text-slate-700"><%= currentUser.name %></span>
              <span class="block text-[0.65rem] uppercase tracking-widest text-slate-400"><%= isAdmin ? 'Admin' : 'Staff' %></span>
            </div>
            <svg class="h-4 w-4 text-slate-400 transition" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div
            class="absolute right-0 z-40 mt-2 hidden min-w-[13rem] rounded-2xl border border-slate-100 bg-white/95 p-2 text-sm shadow-xl ring-1 ring-black/5"
            data-dropdown-menu
            role="menu"
          >
            <a
              href="/profile"
              class="flex items-center gap-2 rounded-xl px-3 py-2 text-slate-600 transition hover:bg-primary-50 hover:text-primary-700"
              role="menuitem"
            >
              <svg class="h-5 w-5 text-primary-500" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 7.5a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 20.25a8.25 8.25 0 0 1 15 0" />
              </svg>
              โปรไฟล์ของฉัน
            </a>
            <a
              href="<%= dashboardLink %>"
              class="flex items-center gap-2 rounded-xl px-3 py-2 text-slate-600 transition hover:bg-primary-50 hover:text-primary-700"
              role="menuitem"
            >
              <svg class="h-5 w-5 text-primary-500" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5h15M6 16.5v-6a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3v6" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19.5v-3.75A1.5 1.5 0 0 1 10.5 14.25h3a1.5 1.5 0 0 1 1.5 1.5V19.5" />
              </svg>
              กลับสู่แดชบอร์ด
            </a>
            <% if (isAdmin) { %>
              <a
                href="/admin/settings"
                class="flex items-center gap-2 rounded-xl px-3 py-2 text-slate-600 transition hover:bg-primary-50 hover:text-primary-700"
                role="menuitem"
              >
                <svg class="h-5 w-5 text-primary-500" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 6h.01M4.5 12a7.5 7.5 0 1 1 15 0 7.5 7.5 0 0 1-15 0Z" />
                </svg>
                ตั้งค่าเว็บไซต์
              </a>
            <% } %>
            <div class="my-1 border-t border-slate-100"></div>
            <form action="/logout" method="post" role="menuitem">
              <button
                type="submit"
                class="flex w-full items-center gap-2 rounded-xl px-3 py-2 text-left text-rose-600 transition hover:bg-rose-50"
              >
                <svg class="h-5 w-5 text-rose-500" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 7.5h4.5m0 0V3m0 4.5L15 7.5m4.5 9H15m4.5 0V21m0-4.5L15 16.5M9 21h-1.5A2.25 2.25 0 0 1 5.25 18.75V5.25A2.25 2.25 0 0 1 7.5 3H9" />
                </svg>
                ออกจากระบบ
              </button>
            </form>
          </div>
        </div>
      <% } else { %>
        <a
          href="/login"
          class="inline-flex items-center gap-2 rounded-full border border-primary-200/70 bg-white px-3 py-1.5 text-sm font-semibold text-primary-600 transition hover:bg-primary-50"
        >
          เข้าสู่ระบบ
        </a>
        <a
          href="/register"
          class="inline-flex items-center gap-2 rounded-full bg-primary-600 px-4 py-1.5 text-sm font-semibold text-white shadow-sm transition hover:-translate-y-0.5 hover:bg-primary-700"
        >
          สมัครสมาชิก
        </a>
      <% } %>
    </div>

    <button
      type="button"
      class="inline-flex items-center justify-center rounded-full border border-white/70 bg-white/95 p-2 text-slate-600 shadow-sm transition hover:border-primary-200 hover:text-primary-600 md:hidden"
      data-nav-toggle
      aria-expanded="false"
      aria-label="เปิดเมนู"
    >
      <svg class="h-5 w-5 transition-transform duration-200" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" data-nav-toggle-icon aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 12h16M4 17h16" />
      </svg>
    </button>
  </div>

  <div class="hidden border-t border-slate-100 bg-white/95 shadow-lg md:hidden" data-nav-panel>
    <div class="mx-auto max-w-6xl px-4 pb-4 sm:px-6 lg:px-8">
      <div class="mt-3 space-y-3 rounded-3xl border border-slate-200 bg-white/95 p-4 shadow-inner">
        <a
          href="<%= homeHref %>"
          class="flex items-center gap-2 rounded-2xl border border-transparent px-3 py-2 text-sm font-medium text-slate-600 transition hover:border-primary-200 hover:text-primary-600 hover:shadow-sm"
        >
          <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="m3 11.25 9-6.75 9 6.75m-2.25 0v6.75a1.5 1.5 0 0 1-1.5 1.5h-3.75m-6-8.25v8.25a1.5 1.5 0 0 0 1.5 1.5H12" />
          </svg>
          หน้าเว็บไซต์
        </a>

        <% if (isAuthenticated) { %>
          <details class="group rounded-2xl border border-slate-200 bg-white/95 p-3">
            <summary class="flex cursor-pointer items-center justify-between text-sm font-semibold text-slate-700">
              จัดการระบบ
              <svg class="h-4 w-4 text-slate-400 transition group-open:rotate-180" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="m6 9 6 6 6-6" />
              </svg>
            </summary>
            <div class="mt-3 space-y-2 text-sm text-slate-600">
              <a href="<%= dashboardLink %>" class="block rounded-xl px-3 py-2 transition hover:bg-primary-50 hover:text-primary-700"><%= dashboardLabel %></a>
              <% if (isAdmin) { %>
                <a href="/admin/slider" class="block rounded-xl px-3 py-2 transition hover:bg-primary-50 hover:text-primary-700">จัดการภาพสไลด์</a>
                <a href="/admin/news" class="block rounded-xl px-3 py-2 transition hover:bg-primary-50 hover:text-primary-700">ข่าวประชาสัมพันธ์</a>
                <a href="/admin/settings" class="block rounded-xl px-3 py-2 transition hover:bg-primary-50 hover:text-primary-700">ตั้งค่าเว็บไซต์</a>
                <a href="/register" class="block rounded-xl px-3 py-2 transition hover:bg-primary-50 hover:text-primary-700">เพิ่มสมาชิกใหม่</a>
              <% } %>
            </div>
          </details>
          <details class="group rounded-2xl border border-slate-200 bg-white/95 p-3">
            <summary class="flex cursor-pointer items-center justify-between text-sm font-semibold text-slate-700">
              <div class="flex items-center gap-2">
                <span class="grid h-8 w-8 place-items-center rounded-full bg-primary-600 text-sm font-semibold uppercase text-white shadow-sm">
                  <%= (currentUser.name || '?').slice(0, 1).toUpperCase() %>
                </span>
                <div class="text-left leading-tight">
                  <span class="block max-w-[12rem] truncate text-sm font-semibold text-slate-700"><%= currentUser.name %></span>
                  <span class="block text-[0.65rem] uppercase tracking-widest text-slate-400"><%= isAdmin ? 'Admin' : 'Staff' %></span>
                </div>
              </div>
              <svg class="h-4 w-4 text-slate-400 transition group-open:rotate-180" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="m6 9 6 6 6-6" />
              </svg>
            </summary>
            <div class="mt-3 space-y-2 text-sm text-slate-600">
              <a href="/profile" class="block rounded-xl px-3 py-2 transition hover:bg-primary-50 hover:text-primary-700">โปรไฟล์ของฉัน</a>
              <a href="<%= dashboardLink %>" class="block rounded-xl px-3 py-2 transition hover:bg-primary-50 hover:text-primary-700">กลับสู่แดชบอร์ด</a>
              <form action="/logout" method="post">
                <button
                  type="submit"
                  class="flex w-full items-center justify-start gap-2 rounded-xl px-3 py-2 text-left text-rose-600 transition hover:bg-rose-50"
                >
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 7.5h4.5m0 0V3m0 4.5L15 7.5m4.5 9H15m4.5 0V21m0-4.5L15 16.5M9 21h-1.5A2.25 2.25 0 0 1 5.25 18.75V5.25A2.25 2.25 0 0 1 7.5 3H9" />
                  </svg>
                  ออกจากระบบ
                </button>
              </form>
            </div>
          </details>
        <% } else { %>
          <p class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600">
            เข้าสู่ระบบเพื่อจัดการสมาชิกและข่าวสารได้สะดวกยิ่งขึ้น
          </p>
          <a
            href="/login"
            class="flex items-center justify-center gap-2 rounded-2xl border border-primary-200/70 bg-white px-3 py-2 text-sm font-medium text-primary-600 transition hover:bg-primary-50"
          >
            เข้าสู่ระบบ
          </a>
          <a
            href="/register"
            class="flex items-center justify-center gap-2 rounded-2xl bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:-translate-y-0.5 hover:bg-primary-700"
          >
            สมัครสมาชิก
          </a>
        <% } %>
      </div>
    </div>
  </div>
</nav>

<script>
  (() => {
    const toggle = document.querySelector('[data-nav-toggle]');
    const panel = document.querySelector('[data-nav-panel]');
    const icon = toggle?.querySelector('[data-nav-toggle-icon]');
    const dropdowns = Array.from(document.querySelectorAll('[data-dropdown]'));

    const closeAllDropdowns = (except = null) => {
      dropdowns.forEach((dropdown) => {
        if (dropdown === except) return;
        const menu = dropdown.querySelector('[data-dropdown-menu]');
        const button = dropdown.querySelector('[data-dropdown-button]');
        if (menu && !menu.classList.contains('hidden')) {
          menu.classList.add('hidden');
          button?.setAttribute('aria-expanded', 'false');
        }
      });
    };

    dropdowns.forEach((dropdown) => {
      const button = dropdown.querySelector('[data-dropdown-button]');
      const menu = dropdown.querySelector('[data-dropdown-menu]');
      if (!button || !menu) return;

      button.addEventListener('click', (event) => {
        event.stopPropagation();
        const isHidden = menu.classList.contains('hidden');
        closeAllDropdowns(dropdown);
        if (isHidden) {
          menu.classList.remove('hidden');
          button.setAttribute('aria-expanded', 'true');
        } else {
          menu.classList.add('hidden');
          button.setAttribute('aria-expanded', 'false');
        }
      });
    });

    document.addEventListener('click', (event) => {
      if (dropdowns.some((dropdown) => dropdown.contains(event.target))) {
        return;
      }
      closeAllDropdowns();
    });

    const closeMobilePanel = () => {
      if (!toggle || !panel) return;
      if (!panel.classList.contains('hidden')) {
        panel.classList.add('hidden');
        toggle.setAttribute('aria-expanded', 'false');
        if (icon) {
          icon.classList.remove('rotate-180');
        }
      }
    };

    toggle?.addEventListener('click', () => {
      if (!panel) return;
      panel.classList.toggle('hidden');
      const isHidden = panel.classList.contains('hidden');
      toggle.setAttribute('aria-expanded', (!isHidden).toString());
      if (icon) {
        icon.classList.toggle('rotate-180', !isHidden);
      }
    });

    panel?.querySelectorAll('a, button').forEach((element) => {
      element.addEventListener('click', () => closeMobilePanel());
    });
  })();
</script>
